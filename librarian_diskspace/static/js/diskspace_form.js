// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  var addUuidField, currentUuid, diskForm, diskFormContainer, errorMessage, handleButton, markDone, pollState, reloadForm, section, setIcon, stateUrl, submitData, updateForm, url, uuidField;
  diskFormContainer = $('#dashboard-diskspace-panel');
  section = diskFormContainer.parents('.o-collapsible-section');
  diskForm = diskFormContainer.find('form');
  url = diskForm.attr('action');
  stateUrl = diskForm.data('state-url');
  currentUuid = diskForm.data('started');
  errorMessage = templates.diskspaceConsolidateSubmitError;
  uuidField = null;
  addUuidField = function() {
    var field;
    field = $('<input type="hidden" name="uuid">');
    (diskFormContainer.find('form')).append(field);
    return field;
  };
  updateForm = function(markup) {
    diskFormContainer.html(markup);
    diskForm = diskFormContainer.find('form');
    uuidField = addUuidField();
    section.trigger('remax');
  };
  reloadForm = function() {
    var res;
    res = $.get(url);
    return res.done(updateForm);
  };
  setIcon = function(button, name) {
    (button.find('.icon')).remove();
    return button.prepend("<span class=\"icon icon-" + name + "\"></span>");
  };
  markDone = function(uuid) {
    var button;
    button = diskFormContainer.find('#' + uuid);
    setIcon(button, 'ok');
    button.addClass('diskspace-consolidation-started');
    return setTimeout(function() {
      button.removeClass('diskspace-consolidation-started');
      return setIcon(button, 'folder-right');
    }, 6000);
  };
  pollState = function(uuid) {
    return setTimeout(function() {
      var res;
      res = $.get(stateUrl);
      return res.done(function(data) {
        if (data.state != null) {
          reloadForm();
          pollState(uuid);
          return;
        }
        console.log('done');
        markDone(uuid);
      });
    }, 2000);
  };
  submitData = function(e) {
    var res, uuid;
    e.preventDefault();
    res = $.post(url, diskForm.serialize());
    uuid = uuidField.val();
    res.done(function(data) {
      updateForm(data);
      if ((diskFormContainer.find('.o-form-errors')).length) {
        return;
      }
      pollState(uuid);
    });
    res.fail(function() {
      diskFormContainer.prepend(errorMessage);
    });
  };
  handleButton = function(e) {
    var el, uuid;
    el = $(e.target);
    uuid = el.attr('value');
    uuidField.val(uuid);
  };
  uuidField = addUuidField();
  diskFormContainer.on('click', 'button', handleButton);
  diskFormContainer.on('submit', 'form', submitData);
  if (currentUuid) {
    return pollState(currentUuid);
  }
})(this, this.jQuery, this.templates);
